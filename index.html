<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="Cache-Control" content="no-store" />
<title>Chat do Loonie</title>

<style>
  :root {
    --bg: #0c0b10;
    --panel: #141320;
    --accent: #b414ff;
    --accent2: #448aff;
    --text: #eee;
    --bubbleSelf: #1f1d2f;
    --bubbleOther: #26233a;
    --danger: #ff3b3b;
    --font-base: 20px;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-size: var(--font-base);
    font-family: "JetBrains Mono", monospace;
    height: 100vh;
    width: 100%;
    display: flex;
    justify-content: center;   
    align-items: center;      
  }

  #app {
    width: 95%;
    max-width: 900px;
    height: 60%;
    background: #100f18;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 0 15px #0008;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #container {
    flex: 1;
    display: flex;
    gap: 10px;
    height: 55vh;   
  }

  .panel {
    background: var(--panel);
    border: 1px solid #333;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  #online {
    width: 22%;
  }

  #users {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  #online h3 {
    margin: 0;
    padding: 8px;
    background: #1b1925;
    border-bottom: 1px solid #333;
    text-align: center;
    font-weight: bold;
    color: var(--accent2);
    font-size: 18px;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #tabs {
    display: flex;
    background: #1b1925;
    border-bottom: 1px solid #333;
  }

  .tab {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    font-size: 18px;
  }

  .tab.active {
    border-bottom: 2px solid var(--accent2);
  }

  .rename {
  padding: 6px 12px;
  cursor: pointer;
  border: 1px solid var(--accent2);
  border-radius: 6px;
  font-size: 16px;
  color: #fff;
  background-color: var(--panel);
  margin-left: auto;
  transition: 0.2s;
}

.rename:hover {
  background-color: var(--accent2);
  color: #000;
}

  .notif {
    display: inline-block;
    width: 9px;
    height: 9px;
    background: var(--danger);
    border-radius: 50%;
    margin-left: 6px;
  }

  #contentWrapper {
    flex: 1;
    overflow: hidden;
    display: flex;
  }

  .content {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 19px;
    display: none;
  }

  .content.active {
    display: block;
  }

  .msg {
    margin-bottom: 10px;
    max-width: 85%;
    padding: 8px 12px;
    border-radius: 10px;
    line-height: 1.25rem;
  }

  .self {
    background: var(--bubbleSelf);
    margin-left: auto;
    border-left: 2px solid var(--accent2);
  }

  .other {
    background: var(--bubbleOther);
    border-left: 2px solid var(--accent);
  }

  .nome {
    font-weight: bold;
    color: var(--accent2);
  }

.Sumiu {
  padding: 6px 12px;
  cursor: pointer;
  border: 1px solid var(--accent2);
  border-radius: 8px;
  font-size: 16px;
  color: #fff;
  background-color: var(--panel);
  transition: 0.2s;
}

#non {
  border-radius: 12px;
  background-color: #1b1925;
  border: 1px solid var(--accent2);
  padding: 8px;
  color: white;
  height: 40%;
  width: 90%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  position: fixed;
  z-index: 99999999;
  opacity: 1;
  transition: opacity 0.3s ease;
  pointer-events: auto;
  display: flex;
  flex-direction:  column;
  justify-content: center;
  align-items: center;
}

#non.sumir {
  opacity: 0;
  pointer-events: none;
}

#nan {
  padding: 8px;
  border: 1px solid var(--accent2);
  background-color: black;
}

  #entrada {
    box-sizing: border-box;
    border: none;
    background: #16161d;
    font-size: 20px;
    padding: 10px;
    color: var(--text);
    outline: none;
    border-top: 1px solid #333;
    height: 40px;
    width: 100%;
    border-radius: 8px;
  }

  #entrada::placeholder {
    color: #777;
  }

  ::-webkit-scrollbar { width: 10px; }
  ::-webkit-scrollbar-track { background: #111; }
  ::-webkit-scrollbar-thumb { background: #333; }
  ::-webkit-scrollbar-thumb:hover { background: #444; }

  #perfilMini {
  position: absolute;
  background: #1b1925;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px;
  width: 200px;
  z-index: 100;
  display: none;
  box-shadow: 0 0 12px #0008;
}

#perfilMini h4 {
  margin: 0 0 8px;
  font-size: 16px;
  color: var(--accent2);
}

#perfilMini button {
  background: var(--accent2);
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  width: 100%;
  margin-top: 6px;
}

#perfilMini button:hover {
  opacity: .9;
}

.clickable {
  cursor: pointer;
}
.clickable:hover {
  color: var(--accent);
}

</style>
</head>
<body>
<div id="non">
  <h1>Bem-vindo ao Chat do Loon</h1>
  <p id="nan">Use "/pv NOME MENSAGEM"<br>• Caso queira usar o privado, ou apenas clique no nick da mensagem</p>
  <button class="Sumiu" onclick="Sumi()">Fechar</button>
</div>
<div id="app">

  <div id="container">

    <div id="main">

      <div id="tabs">
        <div id="tab-geral" class="tab active">Geral</div>
        <div id="tab-priv" class="tab">Privados</div>
        <button id="reset-nm" class="rename" onclick="Rename()">Novo nome</button>
      </div>

      <div id="contentWrapper">
        <div id="gerais" class="content active"></div>
        <div id="privados" class="content"></div>
      </div>

    </div>

    <div id="online" class="panel">
      <h3 id="onlines">Online: 0</h3>
      <div id="users"></div>
    </div>

  </div>

  <input id="entrada" placeholder="Digite aqui e ENTER…" />
  <div id="perfilMini"></div>

</div>


<script>
  const ws = new WebSocket("wss://chat-production-97fb.up.railway.app");

  let nome = localStorage.getItem("nome") || null
  let pegouNome = nome === null ? false : true
  let listaUsuarios = [];
 
  ws.onopen = () => {
  if(pegouNome) {
	  ws.send(JSON.stringify({ tipo: "login", nome }))
	  mostrarGeral("Sistema", `Bem vindo de volta ${nome}`)
  } else {
	  mostrarGeral("Sistema", "Ponha seu nick pra ser identificado, caso ponha espaço você gosta de negões", false)
  }
  }
  
  const non = document.getElementById("non")
  const onlines = document.getElementById("onlines")
  const rename = document.getElementById("reset-nm")
  const gerais   = document.getElementById("gerais");
  const privados = document.getElementById("privados");
  const users    = document.getElementById("users");
  const entrada  = document.getElementById("entrada");
  const perfilMini = document.getElementById("perfilMini");
  const tabGeral = document.getElementById("tab-geral");
  const tabPriv  = document.getElementById("tab-priv");

  entrada.blur()
  let activeTab = "geral";
  let notifGeral = false;
  let notifPriv  = false;

function Sumi() {
  non.classList.add("sumir")
  setTimeout(() => {
    non.style.display = "none"
  }, 300)
}

function Rename() {
  localStorage.removeItem("nome")
  nome = null
  pegouNome = false
  mostrarGeral("Sistema", "Digite um novo nome:")
  entrada.focus()
}

function abrirPerfil(nome, x, y) {
  perfilMini.innerHTML = `
    <h4>${nome}</h4>
    <button onclick="pvUser('${nome}')">PV</button>
  `;

  const scrollY = window.scrollY || document.documentElement.scrollTop;
  perfilMini.style.left = x + "px";
  perfilMini.style.top = (y + scrollY) + "px";
  perfilMini.style.display = "block";
}

function fecharPerfil() {
  perfilMini.style.display = "none";
}

function pvUser(nome) {
  entrada.value = `/pv ${nome} `;
  entrada.focus();
  fecharPerfil();
}

  function switchTab(tab) {
    activeTab = tab;
    tabGeral.classList.remove("active");
    tabPriv.classList.remove("active");

    gerais.classList.remove("active");
    privados.classList.remove("active");

    if (tab === "geral") {
      tabGeral.classList.add("active");
      gerais.classList.add("active");
      notifGeral = false;
      updateNotifs();
    } else {
      tabPriv.classList.add("active");
      privados.classList.add("active");
      notifPriv = false;
      updateNotifs();
    }
  }

  function updateNotifs() {
    tabGeral.innerHTML = `Geral${notifGeral ? ' <span class="notif"></span>' : ''}`;
    tabPriv.innerHTML  = `Privados${notifPriv ? ' <span class="notif"></span>' : ''}`;
  }

  tabGeral.onclick = () => switchTab("geral");
  tabPriv.onclick  = () => switchTab("priv");

  function addMsg(container, user, text, own = false) {
    const div = document.createElement("div");
    div.className = "msg " + (own ? "self" : "other");
    div.innerHTML = `<span class="nome clickable">${user}</span><br>${text}`;
    container.appendChild(div);
    div.querySelector(".clickable").addEventListener("click", (e) => {
    const rect = e.target.getBoundingClientRect();
    abrirPerfil(user, rect.left, rect.bottom + 4);
    });
    container.scrollTop = container.scrollHeight;
  }

  function mostrarPrivado(nomeUsuario, texto, own=false) {
    if (activeTab !== "priv") notifPriv = true;
    updateNotifs();
    addMsg(privados, nomeUsuario, texto, own);
  }

  function mostrarGeral(nomeUsuario, texto, own=false) {
    if (activeTab !== "geral") notifGeral = true;
    updateNotifs();
    addMsg(gerais, nomeUsuario, texto, own);
  }

  function atualizarSidebar() {
    users.innerHTML = listaUsuarios
      .map(u => "• " + u)
      .join("<br>");
      onlines.innerHTML = "Online: " + listaUsuarios.length;
  }


  entrada.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    let texto = entrada.value.trim();
    entrada.value = "";

    if (!pegouNome) {
      if (!texto) {
        mostrarGeral("Sistema", "DIGITA O NOME, ANIMAL", false);
        return;
      }
      nome = texto.replace(/\s+/g, "")
      pegouNome = true
      localStorage.setItem("nome", nome)
      mostrarGeral("Sistema", `Bem-vindo, ${nome}!`, false);
      ws.send(JSON.stringify({ tipo: "login", nome }));
      return;
    }

    if (!texto) return;

    if (texto.startsWith("/pv ")) {
      const [, para, ...resto] = texto.split(" ");
      const msg = resto.join(" ");

      if (!para || !msg) {
        mostrarPrivado("Sistema", "Formato: /pv NOME msg");
        return;
      }

      ws.send(JSON.stringify({ tipo:"pv", para, texto: msg }));
      mostrarPrivado(`Você → ${para}`, msg, true);
      return;
    }

    if (texto === "/off") {
      ws.send(JSON.stringify({ tipo:"kill", nome }));
      ws.close();
      return;
    }

    ws.send(JSON.stringify({ tipo:"msg", nome, texto }));
    mostrarGeral("Você", texto, true);
  });

  ws.onmessage = raw => {
    const data = JSON.parse(raw.data);

    if (data.tipo === "msg") {
      return mostrarGeral(data.nome, data.texto);
    }

    if (data.tipo === "pv") {
      return mostrarPrivado(data.de, data.texto);
    }

    if (data.tipo === "online") {
      listaUsuarios = data.usuarios || [];
      atualizarSidebar();
    }
  };

  ws.onclose = () => {
    mostrarGeral("Sistema", "Servidor desconectado.")
    window.location.href = window.location.href.split("?")[0] + "?t=" + new Date().getTime()
  };

document.addEventListener("click", (e) => {
  if (!perfilMini.contains(e.target) && !e.target.classList.contains("clickable")) {
    fecharPerfil();
  }
});

</script>
</body>
</html>
